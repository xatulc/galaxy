# 事务
## 事务的特性
事务ACID：
1. 原子性（Atomicity）
   一个事务中所有操作要么都做，要么都不做
2. 一致性（Consistency）
   一致性是指数据库中的数据在事务操作前和事务处理后必须满足业务规则约束
   eg：甲乙账户的总金额在转账前和转账后必须一致，如有不一致，则必须是短暂的，且只有在事务提交前才会出现。
3. 隔离性（Isolation)）
   隔离是指数据库允许多个并发事务同时对数据进行读写和修改的能力，隔离性可以防止多个事务并发执行时由于交叉执行导致数据不一致。
4. 持久性（Durability）
   事务处理结束后，对数据的修改是永久性，即使发生故障也不会丢失。

从本质上来说，原子性、隔离性、持久性，最终目的都是为了保证一致性。即一致性是最终目标，原子性、隔离性、持久性可以说都是为了实现这一目标的手段。
## 事务语句
事务开启语句是由begin，事务结束是以commit或者rollback显示结束
```text
begin;
DML语句
commit/rollback
```
MySql数据库可以使用autocommit=1开启自动提交，关闭手动提交。

Oracle数据库中事务不是自动提交的，而MySql为什么要关闭自动提交？
1. 不用一个事务一次提交了，提高了每秒处理事务的能力。
2. 如果过程中某个事务一直没有提交，就会导致行锁等待的现象，就会严重影响数据库的TPS值。

## truncate和delete的区别
truncate是DDL语句操作，delete是DML语句操作。
* truncate不能回滚，delete可以回滚

* truncate可以清空表的自增id属性，从1开始重新记录，而delete不会。

## 事务隔离级别
### SQL 标准定义了四个隔离级别：
```text
+-----------------+-------+--------+-------+
|   隔离级别         | 脏读 | 不可重复读 | 幻读 |
+-----------------+-------+--------+-------+
| READ-UNCOMMITTED |   √   |    √    |   √   |
| READ-COMMITTED   |   ×   |    √    |   √   |
| REPEATABLE-READ  |   ×   |    ×    |   √   |
| SERIALIZABLE     |   ×   |    ×    |   ×   |
+-----------------+-------+--------+-------+
```
#### 读未提交（read uncommitted）
在其中一个事务中，可以读取到其他事务未提交的数据变化。读取到其他还没有提交的事务叫做脏读。
#### 读已提交（read committed）
在其中一个事务中，可以读取到其他事务已经提交的数据变化。这种读取叫做不可重复读，允许幻读现象的发生，是Oracle数据库默认的事务隔离级别。
#### 可重复读（repeatable read）
在其中一个事务中，直到事务结束前，都可以读取到事务刚开始看到的数据，并一直不会发生变化，避免了脏读、不可重复读、幻读的发生
#### 串行
在每个读的数据行上都需要加表级共享锁，在每次写数据时都要加表级排他锁，并发能力严重下降

### MySql中的四个隔离级别
标准的 SQL 隔离级别定义里，REPEATABLE-READ(可重复读)是不可以防止幻读的。

但是！InnoDB 实现的 REPEATABLE-READ 隔离级别其实是可以解决幻读问题发生的。

主要有下面两种情况：

```text
快照读：由 MVCC 机制来保证不出现幻读。

当前读：使用 Next-Key Lock 进行加锁来保证不出现幻读，Next-Key Lock 是行锁（Record Lock）和间隙锁（Gap Lock）的结合，行锁只能锁住已经存在的行，为了避免插入新行，需要依赖间隙锁。因为隔离级别越低，事务请求的锁越少，所以大部分数据库系统的隔离级别都是 READ-COMMITTED ，但是 InnoDB 存储引擎默认使用 REPEATABLE-READ 并不会有任何性能损失。
```
### 查询InnoDB的隔离级别
MySql InnoDB存储引擎实现SQL标准的4种隔离级别。
低级别的隔离级一般支持更高的并发处理，并拥有更低的系统开销。MySql数据库通过 SELECT @@tx_isolation;命令来查看，MySQL 8.0 该命令改为SELECT @@transaction_isolation; 来查看当前数据库的隔离级别
```text
+-----------------------+-----------------+
| Variable_name         | Value           |
+-----------------------+-----------------+
| transaction_isolation | REPEATABLE-READ |
+-----------------------+-----------------+
```
MySql默认的隔离级别是 REPEATABLE-READ



## 脏读、不可重复读、幻读
### 脏读
脏读是在事务隔离级别 读未提交 中出现的问题。一个事务读取到另一个正在进行中的事务提交的数据

### 不可以重复读和幻读
不可重复读指在其中一个事务中，读取到其他事务对旧数据的修改完毕的记录（常见的update和delete语句）

幻读指在一个事务中，读取到其他事务新增的数据，仿佛出现了幻影（常见insert语句）

## InnoDB如何解决的幻读
next-key lock + mvcc
### next-key lock
Innodb 为解决幻读问题引入了间隙锁+行锁充当范围锁

具体可以看MySql-锁
### InnoDB存储引擎对MVCC的实现
多版本控制（Multi-Version Concurrency Control）

